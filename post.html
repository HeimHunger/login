<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HeimHunger â€“ Gericht posten</title>
  <style>
    /* (bestehendes CSS unverÃ¤ndert) */
  </style>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAZvGocBAsVTSOcAe_Qe2Kx8tF83BeN4U4"></script>
</head>
<body>
  <div class="banner"></div>
  <div class="main-wrapper">
    <nav>
      <h1>HeimHunger ğŸ²</h1>
      <div id="sidebar-links">Ladeâ€¦</div>
    </nav>
    <main>
      <div class="tabs">
        <button id="tab-post" class="active">Neues Gericht</button>
        <button id="tab-list">Meine Gerichte</button>
      </div>

      <!-- Formular-Tab -->
      <section id="content-post" class="tab-content active">
        <form id="mealForm">
          <input type="text" id="name" placeholder="Name des Gerichts" required />
          <textarea id="description" placeholder="Beschreibung" rows="4" required></textarea>
          <input type="number" id="price" placeholder="Preis (â‚¬)" step="0.01" required />
          <input type="datetime-local" id="pickup_time" required />
          <input type="text" id="address" placeholder="Adresse (z.B. StraÃŸe Hausnummer, PLZ Ort)" required />
          <input type="url" id="image_url" placeholder="Bild-URL" required />
          <button type="submit">Posten</button>
          <div id="status" class="status"></div>
        </form>
      </section>

      <!-- Meine-Gerichte-Tab -->
      <section id="content-list" class="tab-content">
        <div class="meal-list" id="myMeals"></div>
      </section>
    </main>
  </div>
  <footer>
    <p>&copy; 2025 HeimHunger</p>
  </footer>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient('https://qqhrtpbazuupayhvelrm.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFxaHJ0cGJhenV1cGF5aHZlbHJtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcyMjEyODgsImV4cCI6MjA2Mjc5NzI4OH0.wuT6wBQByGUwoUYyWE0cGBETE3AH2H5fYPYYFfSvznw');

    // Elemente
    const sidebar = document.getElementById('sidebar-links');
    const statusEl = document.getElementById('status');
    const form     = document.getElementById('mealForm');
    const tabPost  = document.getElementById('tab-post');
    const tabList  = document.getElementById('tab-list');
    const contPost = document.getElementById('content-post');
    const contList = document.getElementById('content-list');
    const myMeals  = document.getElementById('myMeals');
    let currentUser = null;

    // Initialisierung
    async function init() {
      const { data: { session } } = await supabase.auth.getSession();
      const user = session?.user;
      if (!user) return window.location.replace('index.html');
      currentUser = user;
      supabase.auth.onAuthStateChange((_, s) => { if (!s?.user) window.location.replace('index.html'); });
      renderSidebar();
      setupTabs();
    }

    function renderSidebar() {
      sidebar.innerHTML = `
        <a href="explore.html">Gerichte entdecken</a>
        <a href="post.html">Gericht posten</a>
        <a href="customer.html">Mein Bereich</a>
        <button id="logout">ğŸ”’ Logout</button>
      `;
      document.getElementById('logout').onclick = async () => await supabase.auth.signOut();
    }

    function setupTabs() {
      tabPost.addEventListener('click', () => switchTab('post'));
      tabList.addEventListener('click', () => { switchTab('list'); loadMyMeals(); });
    }

    function switchTab(tab) {
      const isPost = tab === 'post';
      tabPost.classList.toggle('active', isPost);
      tabList.classList.toggle('active', !isPost);
      contPost.classList.toggle('active', isPost);
      contList.classList.toggle('active', !isPost);
    }

    // Formular-Handler mit verbessertem Geocoding-Feedback
    form.addEventListener('submit', async e => {
      e.preventDefault();
      statusEl.textContent = '';
      statusEl.className = 'status';

      const name        = form.name.value.trim();
      const description = form.description.value.trim();
      const price       = parseFloat(form.price.value);
      const pickup_time = form.pickup_time.value;
      const address     = form.address.value.trim();
      const image_url   = form.image_url.value.trim();

      if (!name || !description || isNaN(price) || !pickup_time || !address) {
        statusEl.textContent = 'Bitte alle Felder korrekt ausfÃ¼llen.';
        return statusEl.classList.add('error');
      }

      try {
        const geoRes = await fetch(
          `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=AIzaSyAZvGocBAsVTSOcAe_Qe2Kx8tF83BeN4U4`
        );
        const geoJson = await geoRes.json();
        console.log('Geocoding Response:', geoJson);
        if (geoJson.status === 'ZERO_RESULTS') {
          throw new Error('Adresse nicht gefunden. Bitte vollstÃ¤ndige Adresse eingeben.');
        }
        if (geoJson.status !== 'OK') {
          throw new Error(`Geocoding-Fehler: ${geoJson.status}`);
        }
        const { lat, lng } = geoJson.results[0].geometry.location;

        const { error } = await supabase.from('meals').insert([{ 
          name, description, price, pickup_time, image_url,
          latitude: lat, longitude: lng, user_id: currentUser.id
        }]);
        if (error) throw error;

        statusEl.textContent = 'âœ… Gericht erfolgreich gepostet!';
        statusEl.classList.add('success');
        form.reset();
        switchTab('list');
        loadMyMeals();
      } catch (err) {
        statusEl.textContent = `âŒ Fehler: ${err.message}`;
        statusEl.classList.add('error');
      }
    });

    // Liste eigener Gerichte
    async function loadMyMeals() {
      myMeals.innerHTML = 'Ladeâ€¦';
      const { data, error } = await supabase.from('meals')
        .select('name,description,image_url,pickup_time')
        .eq('user_id', currentUser.id)
        .order('created_at', { ascending: false });
      if (error) return myMeals.textContent = 'Fehler beim Laden Ihrer Gerichte';
      if (!data.length) return myMeals.textContent = 'Sie haben noch keine Gerichte gepostet.';
      myMeals.innerHTML = data.map(m => `
        <div class="meal-card">
          <img src="${m.image_url}" alt="${m.name}" />
          <div class="content">
            <div class="title">${m.name}</div>
            <div class="desc">${m.description}</div>
            <div class="time">Abholung: ${new Date(m.pickup_time).toLocaleString('de-DE')}</div>
          </div>
        </div>
      `).join('');
    }

    init();
  </script>
</body>
</html>
