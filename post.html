<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  const supabase = createClient(
    'https://qqhrtpbazuupayhvelrm.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
  );

  const form = document.getElementById('mealForm');
  const status = document.getElementById('status');
  const sidebar = document.getElementById('sidebar-links');

  // Session & User prÃ¼fen
  const { data: sessionData } = await supabase.auth.getSession();
  if (!sessionData?.session) {
    window.location.href = "index.html";
  }

  const { data: userData } = await supabase.auth.getUser();
  const user = userData?.user;

  if (!user) {
    window.location.href = "index.html";
  } else {
    sidebar.innerHTML = `
      <a href="explore.html">Gerichte entdecken</a>
      <a href="post.html">Gericht posten</a>
      <a href="customer.html">Mein Bereich</a>
      <a href="agb.html">AGB</a>
      <a href="datenschutz.html">Datenschutz</a>
      <button id="logout">ðŸ”’ Logout</button>
    `;
    document.getElementById('logout').addEventListener('click', async () => {
      await supabase.auth.signOut();
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = "index.html";
    });
  }

  // Formular absenden
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const name = document.getElementById('name').value.trim();
    const description = document.getElementById('description').value.trim();
    const price = parseFloat(document.getElementById('price').value);
    const pickup_time = document.getElementById('pickup_time').value;
    const image_url = document.getElementById('image_url').value.trim();

    if (!name || !description || !pickup_time || isNaN(price)) {
      status.textContent = 'Bitte alle Felder korrekt ausfÃ¼llen.';
      status.className = 'error';
      return;
    }

    // Adresse aus User-Metadata zusammensetzen
    const meta = user.user_metadata;
    const address = `${meta.street} ${meta.house_number}, ${meta.zip} ${meta.city}, ${meta.country}`;
    const geoUrl = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=AIzaSyAZvGocBAsVTSOcAe_Qe2Kx8tF83BeN4U4`;

    try {
      const res = await fetch(geoUrl);
      const geo = await res.json();
      if (geo.status !== "OK") throw new Error("Adresse konnte nicht gefunden werden.");
      const { lat, lng } = geo.results[0].geometry.location;

      const { error } = await supabase.from('meals').insert([{
        name,
        description,
        price,
        pickup_time,
        image_url,
        latitude: lat,
        longitude: lng
      }]);

      if (error) {
        status.textContent = 'Fehler beim Posten: ' + error.message;
        status.className = 'error';
      } else {
        status.textContent = 'âœ… Gericht erfolgreich gepostet!';
        status.className = 'success';
        form.reset();
      }
    } catch (err) {
      status.textContent = 'Fehler bei der Geokodierung: ' + err.message;
      status.className = 'error';
    }
  });
</script>
